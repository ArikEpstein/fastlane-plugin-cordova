# Cordova Plugin

[![fastlane Plugin Badge](https://rawcdn.githack.com/fastlane/fastlane/master/fastlane/assets/plugin-badge.svg)](https://rubygems.org/gems/fastlane-plugin-cordova)

## Features

- Build your Cordova project inside a lane
- Automatically handle code signing on iOS, even for XCode 8

## Getting Started

This project is a [fastlane](https://github.com/fastlane/fastlane) plugin. To get started with `fastlane-plugin-cordova`, add it to your project by running:

```bash
fastlane add_plugin cordova
```

Then you can integrate it into your Fastlane setup:

```ruby
platform :ios do
  desc "Deploy ios app on the appstore"

  lane :deploy do
    match(type: "appstore")
    cordova(platform: 'ios')
    appstore(ipa: ENV['CORDOVA_IOS_RELEASE_BUILD_PATH'])
  end
end

platform :android do
  desc "Deploy android app on play store"

  lane :deploy do
    cordova(
      platform: 'android',
      keystore_path: './prod.keystore',
      keystore_alias: 'prod',
      keystore_password: 'password'
    )
    supply(apk: ENV['CORDOVA_ANDROID_RELEASE_BUILD_PATH'])
  end
end
```

with an `Appfile` such as

```ruby
app_identifier "com.awesome.app"
apple_id "apple@id.com"
team_id "28323HT"
```

If using **Crosswalk**, replace `supply(apk: ENV['CORDOVA_ANDROID_RELEASE_BUILD_PATH'])` by:
```
supply(
  apk_paths: [
   'platforms/android/build/outputs/apk/android-armv7-release.apk',
   'platforms/android/build/outputs/apk/android-x86-release.apk'
  ],
)
```

## Plugin API

To check what's available in the plugin, install it in a project and run at the root of the project:
```
fastlane actions cordova
```

Which will produce:

| Key | Description | Env Var | Default |
|-----|-------------|---------|---------|
| **platform**             | Platform to build on. <br>Should be either android or ios | CORDOVA_PLATFORM            |        |
| **release**              | Build for release if true,<br>or for debug if false       | CORDOVA_RELEASE             | *true* |
| **device**               | Build for device                                          | CORDOVA_DEVICE              | *true* |
| **prod**                 | Build for production                                      | CORDOVA_PROD                  | *false* |
| **type**                 | This will determine what type of build is generated by Xcode. <br>Valid options are development, enterprise, adhoc, and appstore| CORDOVA_IOS_PACKAGE_TYPE    | appstore |
| **verbose**              | Pipe out more verbose output to the shell               | CORDOVA_VERBOSE                  |  *false* |
| **team_id**              | The development team (Team ID) to use for code signing  | CORDOVA_IOS_TEAM_ID               | *28323HT* |
| **build_flag**           | An array of Xcode buildFlag. Will be appended on compile command.  | CORDOVA_IOS_BUILD_FLAG               | [] |
| **provisioning_profile** | GUID of the provisioning profile to be used for signing | CORDOVA_IOS_PROVISIONING_PROFILE  |           |
| **keystore_path**        | Path to the Keystore for Android                        | CORDOVA_ANDROID_KEYSTORE_PATH     |           |
| **keystore_password**    | Android Keystore password                               | CORDOVA_ANDROID_KEYSTORE_PASSWORD |           |
| **key_password**         | Android Key password (default is keystore password)     | CORDOVA_ANDROID_KEY_PASSWORD      |           |
| **keystore_alias**       | Android Keystore alias                                  | CORDOVA_ANDROID_KEYSTORE_ALIAS    |           |
| **bundle**               | Android Bundle package                                  | CORDOVA_ANDROID_BUNDLE            |  *false*  |
| **min_sdk_version**      | Overrides the value of minSdkVersion                    | CORDOVA_ANDROID_MIN_SDK_VERSION   |           |
| **build_number**         | Build Number for iOS and Android                        | CORDOVA_BUILD_NUMBER              |           |
| **browserify**           | Specifies whether to browserify build or not            | CORDOVA_BROWSERIFY                |  *false*  |
| **cordova_prepare**      | Specifies whether to run `cordova prepare` before building  | CORDOVA_PREPARE               |  *true*   |
| **cordova_no_fetch**      | Specifies whether to run `cordova platform add` with `--nofetch` parameter  | CORDOVA_NO_FETCH               |  *false*   |
| **cordova_build_config_file**      | Call `cordova compile` with `--buildConfig=<ConfigFile>` to specify build config file path  | CORDOVA_BUILD_CONFIG_FILE               |     |


## Actions

This [Fastfile](./fastlane-plugin-fivethree_ionic/fastlane/Fastfile) contains example of the following actions.

| Action                                                              | Description                                                   |
| ------------------------------------------------------------------- | ------------------------------------------------------------- |
| [add_transparent_statusbar](#add_transparent_statusbar)     |
| [build_android](#build_android)                 |
| [android_keystore](#android_keystore)                       | Generate an Android keystore file or validate keystore exists |
| [build_android](#build_android)                 |
| [bump_version](#bump_version)                               |
| [clean_install](#clean_install)                             |
| [increment_build_no](#increment_build_no)                   |
| [select_env](#select_env)                                   | Select an environment folder for white labeling the app       |
| [sign_android](#sign_android)                               | Zipalign, sign and verify apk                                 |
| [update_version](#update_version)                           |
| [update_version_and_build_number](#update_version_and_build_number) |
| [version](#version)                                         |

### add_transparent_statusbar

### android_keystore

Generate an Android keystore file or validate keystore exists

#### Options

| Options       | Description               | Type     | Default              | Required |
| ------------- | ------------------------- | -------- | -------------------- | -------- |
| keystore_path | Path to the android       | `string` | `./fastlane/android` | `false`  |
| keystore_name | Name of the keystore      | `string` |                      | `true`   |
| key_alias     | Key alias of the keystore | `string` |                      | `true`   |

### build_android

### bump_version

### clean_install

### increment_build_number

#### CI

Environment selection can also be passed as an option for a non interactive environment. Add the option `env` to `before_all` and assign it to an environment variable `ENV`.

```ruby
before_all do |lane, options|
  ENV['ENV'] = options[:env]
end
```

#### Options

| Options             | Description                                     | Type     | Default        | Required |
| ------------------- | ----------------------------------------------- | -------- | -------------- | -------- |
| environments_folder | Path to your environments white label resources | `string` | `environments` | `false` 

### sign_android

Zipaligns, [signs v2](https://source.android.com/security/apksigning/v2) and verifys an apk with a keystore. If the keystore does not exists it uses `android_keystore` to create a new keystore.

```ruby
# run before signing: cordova build android --prod --release

apk_path =
  sign_android(
    keystore_name: 'pizza',
    key_alias: 'pizza',
    app_version: '1.0.1',
    app_build_no: '2020',
    apk_output_dir: './apk',
    silent: true
  )
```

#### Options

| Options                    | Description                                                          | Type     | Default                                                                               | Required |
| -------------------------- | -------------------------------------------------------------------- | -------- | ------------------------------------------------------------------------------------- | -------- |
| keystore_path              | Path to the android                                                  | `string` | `./fastlane/android`                                                                  | `false`  |
| keystore_name              | Name of the keystore used to store storepass and keypass in keychain | `string` |                                                                                       | `true`   |
| android_sdk_path           | Path to your installed Android SDK                                   | `string` | `~/Library/Android/sdk`                                                               | `false`  |
| android_build_tool_version | Android Build Tool version used for `zipalign`, `sign` and `verify`  | `string` | `28.0.3`                                                                              | `false`  |
| apk_source                 | Android Build Tool version used for `zipalign`, `sign` and `verify`  | `string` | `./platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk`          | `false`  |
| apk_zipalign_target        | Target path for the zipaligned apk                                   | `string` | `./platforms/android/app/build/outputs/apk/release/app-release-unsigned-zipalign.apk` | `false`  |
| apk_signed_target          | Target path of the signed apk                                        | `string` | `./platforms/android/app/build/outputs/apk/release`                                   | `false`  |
| key_alias                  | Key alias of the keystore                                            | `string` |                                                                                       | `true`   |
| app_version                | App version                                                          | `string` |                                                                                       | `true`   |
| app_build_no               | App build number                                                     | `string` |                                                                                       | `true`   |

### update_version

### update_version_and_build_number

### version



## Run tests for this plugin

To run both the tests, and code style validation, run

```
rake
```

To automatically fix many of the styling issues, use
```
rubocop -a
```

To automatically code formatting with prettier, use 

```
bundle exec rbprettier --write '**/*.rb'
```

## Issues and Feedback

For any other issues and feedback about this plugin, please submit it to this repository.

## Troubleshooting

If you have trouble using plugins, check out the [Plugins Troubleshooting](https://github.com/fastlane/fastlane/blob/master/fastlane/docs/PluginsTroubleshooting.md) doc in the main `fastlane` repo.

## Using `fastlane` Plugins

For more information about how the `fastlane` plugin system works, check out the [Plugins documentation](https://github.com/fastlane/fastlane/blob/master/fastlane/docs/Plugins.md).

## About `fastlane`

`fastlane` is the easiest way to automate beta deployments and releases for your iOS and Android apps. To learn more, check out [fastlane.tools](https://fastlane.tools).
